{% extends "professor/layout.html" %}

{% block title %}Students - {{ selected_class.name }}{% endblock %}

{% block head %}

    <link rel="stylesheet" href="{{ url_for('static', filename='professor/students.css') }}">

{% endblock %}

{% block content %}
<div class="data-container">
    <h2 class="page-title">Estudiantes - {{ selected_class.name }}</h2>
    
    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash-message {{ category }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}
    
    <!-- Controles -->
    <div class="controls">
        <div class="rows-selector">
            <span>Mostrar</span>
            <div class="dropdown">
                <button class="dropdown-btn">
                    {{ rows_per_page }}
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-content">
                    <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=10, page=1, search=search_term) }}">10</a>
                    <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=25, page=1, search=search_term) }}">25</a>
                    <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=50, page=1, search=search_term) }}">50</a>
                    <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=100, page=1, search=search_term) }}">100</a>
                </div>
            </div>
            <span>estudiantes</span>
        </div>

        <div class="search-container">
            <form action="{{ url_for('professor.students', class_id=selected_class.id) }}" method="get">
                <input type="hidden" name="rows" value="{{ rows_per_page }}">
                <input type="hidden" name="page" value="1">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" name="search" placeholder="Buscar..." value="{{ search_term }}">
                </div>
                <button type="submit" class="btn btn-primary">Buscar</button>
            </form>
        </div>
    </div>
    
    <!-- Bot√≥n de Formaci√≥n de Equipo -->
    <div style="margin-bottom: 1rem;">
        <button id="form-team-btn" class="btn btn-primary">
            <i class="fas fa-users"></i> Formar Equipo
        </button>
    </div>

    <!-- Tabla -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="40px">
                        <input type="checkbox" id="select-all-students" class="student-checkbox">
                    </th>
                    <th>ID</th>
                    <th>Estudiante</th>
                    <th>Email</th>
                    <th>Fecha de Inscripci√≥n</th>
                    <th>Nota</th>
                    <th>Asistencia</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% if students %}
                    {% for student in students %}
                    <tr>
                        <td>
                            <input type="checkbox" class="student-checkbox" data-student-id="{{ student.id }}" data-student-name="{{ student.name }}" data-student-avatar="{{ student.avatar }}" data-student-email="{{ student.email }}" {% if student.in_team %}disabled{% endif %}>
                        </td>
                        <td class="font-medium">{{ student.id }}</td>
                        <td>
                            <div class="user-info">
                                <img src="{{ student.avatar }}" alt="{{ student.name }}" class="avatar">
                                <span>{{ student.name }}</span>
                                {% if student.in_team %}
                                <span class="badge in-team">En Equipo</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ student.email }}</td>
                        <td>{{ student.enrollment_date }}</td>
                        <td>{{ student.grade }}</td>
                        <td>{{ student.attendance }}</td>
                        <td>
                            <span class="badge {{ student.status|lower }}">{{ student.status }}</span>
                        </td>
                        <td>
                            <a href="{{ url_for('professor.delete_student', student_id=student.id, class_id=selected_class.id) }}" class="btn btn-icon">
                                üóëÔ∏è
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="empty-table">No se encontraron estudiantes</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Controles de Formaci√≥n de Equipo -->
    <div id="team-formation-controls" class="team-formation-controls">
        <h3>Crear Nuevo Equipo</h3>
        <form id="create-team-form" action="{{ url_for('professor.create_team', class_id=selected_class.id) }}" method="post">
            <div class="form-group">
                <label for="team_name">Nombre del Equipo</label>
                <input type="text" id="team_name" name="team_name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="team_project">Proyecto</label>
                <input type="text" id="team_project" name="team_project" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>Estudiantes Seleccionados</label>
                <div id="selected-students" class="selected-students">
                    <p>No hay estudiantes seleccionados</p>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancel-team-btn" class="btn btn-outline">Cancelar</button>
                <button type="submit" class="btn btn-primary">Crear Equipo</button>
            </div>
        </form>
    </div>

    <!-- Paginaci√≥n -->
    {% if students %}
    <div class="pagination">
        <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=rows_per_page, page=page-1, search=search_term) }}" 
           class="btn btn-outline {% if page == 1 %}disabled{% endif %}">
            Anterior
        </a>
        <div class="page-numbers">
            {% set display_pages = 3 %}
            {% set start_page = 1 if page <= 2 else (total_pages - 2 if page >= total_pages - 1 else page - 1) %}
            {% set end_page = start_page + display_pages - 1 if start_page + display_pages - 1 <= total_pages else total_pages %}
            
            {% for p in range(start_page, end_page + 1) %}
            <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=rows_per_page, page=p, search=search_term) }}" 
               class="page-number {% if p == page %}active{% endif %}">
                {{ p }}
            </a>
            {% endfor %}
        </div>
        <a href="{{ url_for('professor.students', class_id=selected_class.id, rows=rows_per_page, page=page+1, search=search_term) }}" 
           class="btn btn-outline {% if page == total_pages %}disabled{% endif %}">
            Siguiente
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formTeamBtn = document.getElementById('form-team-btn');
        const teamFormationControls = document.getElementById('team-formation-controls');
        const cancelTeamBtn = document.getElementById('cancel-team-btn');
        const selectAllCheckbox = document.getElementById('select-all-students');
        const studentCheckboxes = document.querySelectorAll('.student-checkbox:not(#select-all-students):not([disabled])');
        const selectedStudentsContainer = document.getElementById('selected-students');
        const createTeamForm = document.getElementById('create-team-form');
        
        // Team roles from server
        const teamRoles = JSON.parse('{{ team_roles | tojson | safe }}');
        
        // Toggle team formation controls
        formTeamBtn.addEventListener('click', function() {
            teamFormationControls.classList.add('active');
            window.scrollTo({
                top: teamFormationControls.offsetTop - 20,
                behavior: 'smooth'
            });
        });
        
        // Cancel team formation
        cancelTeamBtn.addEventListener('click', function() {
            teamFormationControls.classList.remove('active');
            // Uncheck all checkboxes
            selectAllCheckbox.checked = false;
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedStudents();
        });
        
        // Select all students (only those not in teams)
        selectAllCheckbox.addEventListener('change', function() {
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedStudents();
        });
        
        // Individual student selection
        studentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedStudents();
                // Update select all checkbox
                selectAllCheckbox.checked = Array.from(studentCheckboxes).every(cb => cb.checked);
            });
        });
        
        // Update selected students display
        function updateSelectedStudents() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.student-checkbox:checked:not(#select-all-students)'));
            
            if (selectedCheckboxes.length === 0) {
                selectedStudentsContainer.innerHTML = '<p>No students selected</p>';
                return;
            }
            
            let html = '';
            selectedCheckboxes.forEach(checkbox => {
                const studentId = checkbox.dataset.studentId;
                const studentName = checkbox.dataset.studentName;
                const studentAvatar = checkbox.dataset.studentAvatar;
                const studentEmail = checkbox.dataset.studentEmail;
                
                html += `
                <div class="selected-student-card">
                    <input type="hidden" name="selected_students" value="${studentId}">
                    <input type="hidden" name="student_name_${studentId}" value="${studentName}">
                    <img src="${studentAvatar}" alt="${studentName}" class="avatar">
                    <div>
                        <p class="font-medium">${studentName}</p>
                        <p class="text-sm text-muted-foreground">${studentEmail}</p>
                    </div>
                    <div class="role-selector">
                        <select name="student_role_${studentId}" class="form-control" required>
                            <option value="">Select Role</option>
                            ${teamRoles.map(role => `<option value="${role}">${role}</option>`).join('')}
                        </select>
                    </div>
                </div>
                `;
            });
            
            selectedStudentsContainer.innerHTML = html;
        }
        
        // Form validation
        createTeamForm.addEventListener('submit', function(e) {
            const selectedStudents = document.querySelectorAll('input[name="selected_students"]');
            if (selectedStudents.length === 0) {
                e.preventDefault();
                alert('Please select at least one student for the team.');
                return;
            }
            
            // Check if all roles are selected
            let allRolesSelected = true;
            const roleSelects = document.querySelectorAll('select[name^="student_role_"]');
            roleSelects.forEach(select => {
                if (!select.value) {
                    allRolesSelected = false;
                }
            });
            
            if (!allRolesSelected) {
                e.preventDefault();
                alert('Please assign a role to each team member.');
                return;
            }
        });
    });
</script>
{% endblock %}